<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Lamumu × Common: Harmony Dash</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --grid:#0f1526;
      --lamumu:#8b5cf6; /* violet */
      --common:#10b981; /* emerald */
      --accent:#fbbf24; /* amber */
      --danger:#ef4444; /* red */
      --text:#e5e7eb;
      --muted:#9ca3af;
    }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 70% 30%,#0f162b,var(--bg));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji',sans-serif;}
    #ui{position:fixed;inset:0;display:flex;flex-direction:column;pointer-events:none}
    .hud{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:10px 14px}
    .pill{background:#111827cc;border:1px solid #1f2937;border-radius:999px;padding:6px 12px;backdrop-filter:blur(6px);box-shadow:0 8px 24px #0007}
    .tag{font-weight:700;letter-spacing:.4px}
    .lamumu{color:var(--lamumu)}
    .common{color:var(--common)}
    .accent{color:var(--accent)}
    .danger{color:var(--danger)}
    #centerMsg{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center;max-width:min(720px,90vw)}
    #centerMsg .card{pointer-events:auto;background:#0b1222cc;border:1px solid #1f2a44;border-radius:20px;padding:20px 18px;box-shadow:0 20px 60px #000a}
    #centerMsg h1{margin:.2rem 0 0;font-size:clamp(20px,3.5vw,36px)}
    #centerMsg p{color:var(--muted);margin:.4rem 0}
    #centerMsg kbd{background:#111827;border:1px solid #374151;border-bottom-width:3px;border-radius:8px;padding:2px 6px;font-weight:700}
    #centerMsg .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    #centerMsg button{pointer-events:auto;cursor:pointer;background:linear-gradient(180deg,#1f2937,#111827);border:1px solid #374151;border-radius:14px;padding:12px 14px;color:var(--text);font-weight:700;box-shadow:0 10px 30px #0008}
    #centerMsg button.primary{background:linear-gradient(180deg,#3b82f6,#1d4ed8);} 
    #centerMsg small{display:block;color:var(--muted);margin-top:8px}
    canvas{display:block;width:100vw;height:100vh}
    #footer{margin-top:auto;display:flex;justify-content:center;padding:10px}
    #footer .pill{font-size:12px}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="ui">
    <div class="hud">
      <div class="pill" id="modePill"><span class="tag">MODE:</span> <span id="modeTxt" class="lamumu">LAMUMU</span></div>
      <div class="pill"><span class="tag">SCORE:</span> <span id="score">0</span></div>
      <div class="pill"><span class="tag">COMBO:</span> <span id="combo">×1</span></div>
      <div class="pill"><span class="tag">BEST:</span> <span id="best">0</span></div>
    </div>

    <div id="centerMsg">
      <div class="card">
        <h1>Lamumu × Common: <span class="accent">Harmony Dash</span></h1>
        <p>Swap between <span class="lamumu">Lamumu</span> and <span class="common">Common</span> to collect matching orbs, dodge glitches, and build massive combos. No downloads — plays right here.</p>
        <div class="grid">
          <div class="pill">Desktop: <kbd>←</kbd>/<kbd>→</kbd> move, <kbd>Space</kbd> swap, <kbd>P</kbd> pause</div>
          <div class="pill">Mobile: drag to move • tap top to swap • tap bottom to jump</div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
          <button class="primary" id="playBtn">Play</button>
          <button id="howBtn">How to Play</button>
        </div>
        <small>Unofficial fan game inspired by <a href="https://x.com/lamumudotxyz" target="_blank" rel="noreferrer noopener">@lamumudotxyz</a> & <a href="https://x.com/commondotxyz" target="_blank" rel="noreferrer noopener">@commondotxyz</a>.</small>
      </div>
    </div>

    <div id="footer">
      <div class="pill">Tip: Alternate perfect matches to increase the <b>Harmony Meter</b> for bonus points.</div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  let W=0,H=0; const resize=()=>{W=canvas.width=innerWidth*dpr;H=canvas.height=innerHeight*dpr;canvas.style.width=innerWidth+'px';canvas.style.height=innerHeight+'px'}; resize(); addEventListener('resize', resize);

  // UI
  const scoreEl = document.getElementById('score');
  const comboEl = document.getElementById('combo');
  const bestEl = document.getElementById('best');
  const modeTxt = document.getElementById('modeTxt');
  const centerMsg = document.getElementById('centerMsg');
  const playBtn = document.getElementById('playBtn');
  const howBtn = document.getElementById('howBtn');

  const COLORS = { bg:'#0b0f1a', lamumu:'#8b5cf6', common:'#10b981', orb:'#fbbf24', glitch:'#ef4444', grid:'#0f1526', white:'#e5e7eb'};

  // Simple audio (no external assets)
  let audioCtx = null;
  function beep(freq=440, t=0.08, type='sine', vol=0.02){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq; o.connect(g); g.connect(audioCtx.destination);
      g.gain.value = vol; o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + t);
      o.stop(audioCtx.currentTime + t);
    }catch(e){/* ignore */}
  }

  // Game state
  const state = {
    running:false,
    time:0,
    speed:3,
    laneY:0,
    scroll:0,
    score:0,
    combo:1,
    harmony:0, // 0..100
    best: parseInt(localStorage.getItem('harmony_best')||'0',10),
    mode:'lamumu', // or 'common'
    entities:[],
    particles:[],
  };
  bestEl.textContent = state.best;

  // Player
  const player = { x: 120, y: 0, r: 18, vx:0, vy:0, onGround:true, lastMatch:null };

  function lanes(){
    const ground = H*0.78; const mid = ground - 100*dpr; const top = ground - 200*dpr; return [top, mid, ground];
  }
  function reset(){
    state.time=0; state.speed=3; state.scroll=0; state.score=0; state.combo=1; state.harmony=0; state.entities.length=0; state.particles.length=0; state.mode='lamumu';
    player.x = Math.max(90*dpr, W*0.18); player.y = lanes()[1]; player.vx=0; player.vy=0; player.onGround=true; player.lastMatch=null;
    updateUI();
  }

  function updateUI(){
    scoreEl.textContent = state.score|0; comboEl.textContent = '×'+(state.combo|0); modeTxt.textContent = state.mode.toUpperCase();
    modeTxt.className = state.mode==='lamumu'?'lamumu':'common';
  }

  function spawn(){
    // spawn orbs and glitches
    const t = state.time; const baseX = W + 60*dpr; const L = lanes();
    const gap = Math.max(220, 460 - state.time*0.08) * dpr; // adaptive spacing
    if(t % 30 < 1){ // wave
      const kind = Math.random()<0.6? 'orb' : 'glitch';
      const count = 1 + (Math.random()<0.5?0:1);
      for(let i=0;i<count;i++){
        const lane = L[(Math.random()*3)|0];
        const k = Math.random()<0.5? 'lamumu':'common';
        state.entities.push({type:kind, sub: k, x: baseX + i*gap*0.6, y: lane, r: 16*dpr, hit:false});
      }
      // sometimes add a power-up
      if(Math.random()<0.25){
        state.entities.push({type:'power', sub:'harmony', x: baseX + gap*0.9, y: L[0+((Math.random()*3)|0)], r: 14*dpr, hit:false});
      }
    }
  }

  // Input
  const keys = new Set();
  addEventListener('keydown', e=>{
    if(['ArrowLeft','ArrowRight','Space','KeyP'].includes(e.code)) e.preventDefault();
    keys.add(e.code);
    if(e.code==='Space') swapMode();
    if(e.code==='KeyP') togglePause();
  });
  addEventListener('keyup', e=> keys.delete(e.code));

  // Touch
  let touchX=null, touchY=null;
  addEventListener('touchstart', e=>{
    const t = e.changedTouches[0]; touchX=t.clientX; touchY=t.clientY;
    const topHalf = t.clientY < innerHeight*0.42; const bottomHalf = t.clientY > innerHeight*0.58;
    if(topHalf) swapMode(); else if(bottomHalf) jump();
  }, {passive:true});
  addEventListener('touchmove', e=>{
    const t = e.changedTouches[0]; if(touchX!=null){ const dx = t.clientX - touchX; player.x += dx * dpr; touchX = t.clientX; }
  }, {passive:true});
  addEventListener('touchend', ()=>{touchX=null; touchY=null});

  function swapMode(){ state.mode = state.mode==='lamumu'?'common':'lamumu'; updateUI(); beep(state.mode==='lamumu'?520:360,0.05,'triangle',0.025); }
  function jump(){ if(player.onGround){ player.vy = -7*dpr; player.onGround=false; beep(720,0.06,'square',0.02);} }

  function physics(){
    // Move player
    if(keys.has('ArrowLeft')) player.x -= 5*dpr;
    if(keys.has('ArrowRight')) player.x += 5*dpr;
    player.x = Math.max(30*dpr, Math.min(W-30*dpr, player.x));

    // gravity
    const ground = lanes()[2];
    player.vy += 0.35*dpr; player.y += player.vy; if(player.y>=ground){ player.y=ground; player.vy=0; player.onGround=true; }

    // Entities
    const speed = (state.speed + Math.min(8, state.time*0.0009)) * dpr; state.scroll += speed;
    for(const e of state.entities){ e.x -= speed; }
    // cull
    state.entities = state.entities.filter(e=> e.x>-60*dpr && !e.hit);

    // collisions
    for(const e of state.entities){
      const dx = e.x - player.x; const dy = e.y - player.y; const dist2 = dx*dx+dy*dy; const rr = (e.r+player.r)*(e.r+player.r);
      if(dist2 <= rr){
        if(e.type==='orb'){
          e.hit=true; const match = (e.sub===state.mode);
          player.lastMatch = match; state.score += match? (10*state.combo) : -5; if(!match) state.combo=1; else state.combo = Math.min(10, state.combo+1);
          state.harmony = Math.min(100, state.harmony + (match? 8: -15));
          particles(e.x,e.y, match? COLORS.accent: COLORS.glitch);
          beep(match? 880: 200, match? 0.06:0.12, match? 'sine':'sawtooth', match? 0.03:0.02);
        } else if(e.type==='glitch'){
          e.hit=true; state.score -= 12; state.combo = 1; state.harmony = Math.max(0, state.harmony-25);
          shake(10); particles(e.x,e.y,COLORS.glitch); beep(160,0.12,'sawtooth',0.03);
        } else if(e.type==='power'){
          e.hit=true; // Harmony boost + few seconds of dual-collect
          state.harmony = 100; buff.timer = 2600; particles(e.x,e.y, COLORS.white); beep(600,0.18,'triangle',0.04);
        }
      }
    }

    // Passive decay & scoring from harmony meter
    state.harmony = Math.max(0, state.harmony - 0.03);
    if(state.harmony>0){ state.score += (state.harmony/250); }

    // Particles update
    for(const p of state.particles){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.06*dpr; p.a*=0.96; }
    state.particles = state.particles.filter(p=> p.a>0.03);

    // Difficulty increase
    state.time += 1; if(state.time % 600 === 0) state.speed += 0.4;
  }

  // Simple camera shake
  let camShake=0; function shake(a){ camShake = Math.max(camShake, a); }

  function particles(x,y,color){
    for(let i=0;i<10;i++){
      state.particles.push({x,y,vx:(Math.random()-0.5)*3*dpr,vy:(Math.random()-0.8)*3*dpr,a:1,c:color});
    }
  }

  // Temporary buff: dual-collect window
  const buff = { timer:0 };

  // Render helpers
  function drawBackground(){
    // grid parallax
    ctx.save(); ctx.fillStyle = COLORS.bg; ctx.fillRect(0,0,W,H);
    const step = 40*dpr; const s = (state.scroll*0.2)%step;
    ctx.strokeStyle = COLORS.grid; ctx.lineWidth = 1*dpr;
    ctx.beginPath();
    for(let x=-s; x<W; x+=step){ ctx.moveTo(x,0); ctx.lineTo(x,H); }
    for(let y=(H%step); y<H; y+=step){ ctx.moveTo(0,y); ctx.lineTo(W,y); }
    ctx.stroke();
    ctx.restore();
  }

  function drawHarmonyBar(){
    const w = Math.min(520*dpr, W*0.6); const h = 10*dpr; const x = (W-w)/2; const y = 30*dpr;
    ctx.save();
    ctx.fillStyle = '#111827cc'; ctx.fillRect(x,y,w,h);
    ctx.strokeStyle = '#1f2937'; ctx.strokeRect(x,y,w,h);
    ctx.fillStyle = state.mode==='lamumu'? COLORS.lamumu : COLORS.common;
    ctx.fillRect(x,y, w*(state.harmony/100), h);
    ctx.restore();
  }

  function drawPlayer(){
    const c = state.mode==='lamumu'? COLORS.lamumu: COLORS.common;
    ctx.save();
    const sx = (Math.random()*camShake - camShake/2)*dpr; const sy = (Math.random()*camShake - camShake/2)*dpr; camShake*=0.9;
    ctx.translate(sx,sy);

    // body (rounded diamond)
    ctx.translate(player.x, player.y);
    ctx.rotate(Math.sin(state.time*0.08)*0.03);
    const r = player.r;
    const g = ctx.createLinearGradient(-r,-r,r,r); g.addColorStop(0,'#ffffff22'); g.addColorStop(1,c);
    ctx.fillStyle = g; ctx.beginPath();
    ctx.moveTo(0,-r*1.3); ctx.quadraticCurveTo(r*0.9,-r*0.6, r*1.1,0);
    ctx.quadraticCurveTo(r*0.9,r*0.6, 0,r*1.3);
    ctx.quadraticCurveTo(-r*0.9,r*0.6, -r*1.1,0);
    ctx.quadraticCurveTo(-r*0.9,-r*0.6, 0,-r*1.3);
    ctx.fill();
    // outline
    ctx.strokeStyle = '#00000066'; ctx.lineWidth = 2*dpr; ctx.stroke();

    // face: twin dots
    ctx.fillStyle = COLORS.white; ctx.beginPath(); ctx.arc(-r*0.4,-r*0.1, 2.8*dpr, 0, Math.PI*2); ctx.arc(r*0.4,-r*0.1, 2.8*dpr, 0, Math.PI*2); ctx.fill();

    ctx.restore();
  }

  function drawEntities(){
    for(const e of state.entities){
      if(e.type==='orb' || (e.type==='power' && buff.timer>0)){
        // If buff active, all orbs count; power shows differently when not collected yet
      }
      if(e.type==='orb'){
        const c = e.sub==='lamumu'? COLORS.lamumu: COLORS.common;
        ctx.save(); ctx.translate(e.x,e.y);
        ctx.fillStyle = c; ctx.beginPath(); ctx.arc(0,0,e.r,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#0006'; ctx.lineWidth = 2*dpr; ctx.stroke();
        // emblem
        ctx.fillStyle = COLORS.white; ctx.font = (12*dpr)+"px system-ui"; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.globalAlpha = 0.9; ctx.fillText(e.sub==='lamumu'? 'L' : 'C', 0, 1*dpr);
        ctx.restore();
      } else if(e.type==='glitch'){
        ctx.save(); ctx.translate(e.x,e.y);
        ctx.fillStyle = COLORS.glitch; for(let i=0;i<4;i++){ ctx.fillRect(-e.r + i*6*dpr, -e.r + (Math.random()*4-2)*dpr, 6*dpr, 6*dpr); }
        ctx.restore();
      } else if(e.type==='power'){
        ctx.save(); ctx.translate(e.x,e.y);
        const r = e.r;
        ctx.strokeStyle = COLORS.accent; ctx.lineWidth = 2*dpr; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
        ctx.fillStyle = COLORS.accent; ctx.font=(11*dpr)+'px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('★',0,1*dpr);
        ctx.restore();
      }
    }

    // particles
    for(const p of state.particles){ ctx.globalAlpha = p.a; ctx.fillStyle = p.c; ctx.fillRect(p.x-2*dpr,p.y-2*dpr,4*dpr,4*dpr); ctx.globalAlpha = 1; }
  }

  function drawGround(){
    const base = lanes()[2]+20*dpr; const h = H - base; ctx.save();
    const g = ctx.createLinearGradient(0,base,0,H); g.addColorStop(0,'#0a1322'); g.addColorStop(1,'#05070d');
    ctx.fillStyle = g; ctx.fillRect(0,base,W,H-base);
    // horizon glow
    ctx.fillStyle = '#ffffff08'; ctx.fillRect(0,base-10*dpr,W,10*dpr);
    ctx.restore();
  }

  function loop(){
    if(!state.running) return;
    requestAnimationFrame(loop);
    physics();
    drawBackground();
    drawGround();
    drawEntities();
    drawPlayer();
    drawHarmonyBar();

    // spawn
    if(Math.random()<0.9) spawn();

    // buff timer
    if(buff.timer>0){ buff.timer -= 16; }

    // collide scoring tweak when buff active: retroactively set lastMatch true
    if(buff.timer>0){ player.lastMatch = true; }

    updateUI();

    // end? if score below -50
    if(state.score < -50){ gameOver(); }
  }

  function gameOver(){
    state.running=false; if(state.score>state.best){ state.best = state.score|0; localStorage.setItem('harmony_best', state.best); bestEl.textContent = state.best; }
    centerMsg.style.display='block';
    centerMsg.querySelector('h1').innerHTML = 'Run Over — Score '+(state.score|0);
    centerMsg.querySelector('p').innerHTML = 'Tip: Match <span class="lamumu">Lamumu</span> orbs while in Lamumu mode and <span class="common">Common</span> orbs in Common mode. Avoid glitches!';
    playBtn.textContent='Play Again';
  }

  function start(){
    reset(); centerMsg.style.display='none'; state.running=true; requestAnimationFrame(loop); beep(660,0.12,'triangle',0.035);
  }
  function togglePause(){
    if(!state.running){ start(); return; }
    state.running=false; centerMsg.style.display='block'; centerMsg.querySelector('h1').innerHTML='Paused'; centerMsg.querySelector('p').textContent='Press P or tap Play to resume.'; playBtn.textContent='Resume';
  }

  playBtn.addEventListener('click', start);
  howBtn.addEventListener('click', ()=>{
    alert('Goal: Swap modes to match orbs (L = Lamumu, C = Common), dodge red glitches, build combo and fill Harmony Meter.\n\nControls:\nDesktop — Move: ←/→, Swap: Space, Pause: P.\nMobile — Drag to move, tap top to swap, tap bottom to jump.');
  });

  // Allow click-to-start anywhere
  window.addEventListener('pointerdown', ()=>{ if(!state.running) start(); }, {passive:true});

})();
</script>
</body>
</html>
